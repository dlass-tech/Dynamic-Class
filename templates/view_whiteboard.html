{% extends "base.html" %}

{% block title %}{{ whiteboard.name }} - Dlass{% endblock %}

{% block content %}
<div class="view-whiteboard-container">
    <div class="mdc-layout-grid">
        <div class="mdc-layout-grid__inner">
            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
                <div class="whiteboard-header">
                    <h1 class="whiteboard-title">{{ whiteboard.name }}</h1>
                    <div class="whiteboard-actions">
                        <button class="action-btn" onclick="copyWhiteboardUrl()" title="å¤åˆ¶ç™½æ¿è¿æ¥">
                            <i class="material-icons">link</i>
                            <span>å¤åˆ¶é“¾æ¥</span>
                        </button>
                        <button class="action-btn" onclick="refreshWhiteboardStatus()" title="åˆ·æ–°çŠ¶æ€">
                            <i class="material-icons">refresh</i>
                            <span>åˆ·æ–°</span>
                        </button>
                        {% if is_class_teacher %}
                        <a href="{{ url_for('settings.class_settings', class_id=whiteboard.class_id) }}" class="action-btn">
                            <i class="material-icons">settings</i>
                            <span>ç­çº§è®¾ç½®</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
                
                <!-- ç™½æ¿ä¿¡æ¯å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-content">
                        <div class="info-grid">
                            <div class="info-section">
                                <h3>ç™½æ¿ä¿¡æ¯</h3>
                                <div class="info-item">
                                    <span class="info-label">ç™½æ¿ID:</span>
                                    <span class="info-value">{{ whiteboard.board_id }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">æ‰€å±ç­çº§:</span>
                                    <span class="info-value">{{ whiteboard.class_obj.name }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">åˆ›å»ºæ—¶é—´:</span>
                                    <span class="info-value">{{ whiteboard.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">çŠ¶æ€:</span>
                                    <span id="whiteboard-status" class="status-indicator">
                                        {% if whiteboard.is_online %}
                                        <span class="status-online">åœ¨çº¿</span>
                                        {% else %}
                                        <span class="status-offline">ç¦»çº¿</span>
                                        {% endif %}
                                    </span>
                                    <span id="last-heartbeat" class="heartbeat-time">
                                        {% if whiteboard.last_heartbeat %}
                                        (æœ€åå¿ƒè·³: {{ whiteboard.last_heartbeat.strftime('%Y-%m-%d %H:%M') }})
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            <div class="info-section">
                                <h3>è¿æ¥ä¿¡æ¯</h3>
                                <div class="info-item">
                                    <span class="info-label">è¿æ¥URL:</span>
                                        <span class="info-value url-text">
                                            {% if has_token %}
                                                {{ whiteboard_url }}
                                            {% else %}
                                                æœªç”ŸæˆToken <a href="{{ url_for('whiteboards.get_whiteboard_token', whiteboard_id=whiteboard.id) }}">ç‚¹å‡»ä»¥ç”ŸæˆToken</a>
                                            {% endif %}
                                        </span>
                                </div>
                                <div class="qrcode-container" id="qrcode"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- é€‰é¡¹å¡å¯¼èˆª -->
                <div class="tab-navigation">
                    <div class="tab-scroller">
                        <div class="tab-list">
                            <button class="tab-btn active" data-tab="tasks">
                                <span class="tab-icon">ğŸ“‹</span>
                                <span class="tab-label">ä»»åŠ¡</span>
                            </button>
                            {% if is_class_teacher %}
                            <button class="tab-btn" data-tab="announcements">
                                <span class="tab-icon">ğŸ“¢</span>
                                <span class="tab-label">å…¬å‘Š</span>
                            </button>
                            {% endif %}
                            <button class="tab-btn" data-tab="assignments">
                                <span class="tab-icon">ğŸ“š</span>
                                <span class="tab-label">ä½œä¸š</span>
                            </button>
                            <button class="tab-btn" data-tab="history">
                                <span class="tab-icon">ğŸ“Š</span>
                                <span class="tab-label">å†å²è®°å½•</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ä»»åŠ¡é€‰é¡¹å¡ -->
                <div id="tasks-tab" class="tab-content active">
                    <div class="content-card">
                        <div class="card-content">
                            <h3>åˆ›å»ºæ–°ä»»åŠ¡</h3>
                            <form id="create-task-form" class="task-form">
                                <div class="form-group">
                                    <label for="task-title">ä»»åŠ¡æ ‡é¢˜</label>
                                    <input type="text" id="task-title" class="form-input" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="task-description">ä»»åŠ¡æè¿°</label>
                                    <textarea id="task-description" class="form-textarea" rows="3"></textarea>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="task-priority">ä¼˜å…ˆçº§</label>
                                        <select id="task-priority" class="form-select">
                                            <option value="1">ä½</option>
                                            <option value="2">ä¸­</option>
                                            <option value="3">é«˜</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="task-subject">å…³è”å­¦ç§‘ï¼ˆå¯é€‰ï¼‰</label>
                                        <select id="task-subject" class="form-select">
                                            <option value="">æ— å…³è”å­¦ç§‘</option>
                                            {% if is_class_teacher %}
                                                <!-- ç­ä¸»ä»»å¯ä»¥çœ‹åˆ°æ‰€æœ‰å­¦ç§‘ -->
                                                {% for subject in class_subjects_list %}
                                                    <option value="{{ subject }}">{{ subject }}</option>
                                                {% endfor %}
                                            {% elif is_teaching_teacher %}
                                                <!-- æˆè¯¾è€å¸ˆåªèƒ½çœ‹åˆ°è¢«åˆ†é…çš„å­¦ç§‘ -->
                                                {% for subject in assigned_subjects %}
                                                    <option value="{{ subject }}">{{ subject }}</option>
                                                {% endfor %}
                                            {% endif %}
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="task-action">æ‰§è¡Œæ“ä½œ</label>
                                    <select id="task-action" class="form-select">
                                        <option value="0">æ— æ“ä½œ</option>
                                        <option value="1">æ˜¾ç¤ºé€šçŸ¥</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="task-due-date">æˆªæ­¢æ—¶é—´</label>
                                    <input type="datetime-local" id="task-due-date" class="form-input">
                                </div>
                                
                                <button type="submit" class="primary-btn" id="create-task-btn">
                                    <span>åˆ›å»ºä»»åŠ¡</span>
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="content-card">
                        <div class="card-content">
                            <h3>ä»»åŠ¡åˆ—è¡¨</h3>
                            <div class="filter-controls">
                                <button class="filter-btn active" data-filter="all">
                                    <span>å…¨éƒ¨</span>
                                </button>
                                <button class="filter-btn" data-filter="pending">
                                    <span>å¾…å¤„ç†</span>
                                </button>
                                <button class="filter-btn" data-filter="completed">
                                    <span>å·²å®Œæˆ</span>
                                </button>
                            </div>
                            <div id="tasks-list" class="items-list">
                                {% for task in tasks %}
                                <div class="list-item task-item" data-status="{% if task.is_completed %}completed{% elif task.is_acknowledged %}acknowledged{% else %}pending{% endif %}" data-id="{{ task.id }}">
                                    <div class="item-content">
                                        <div class="item-main">
                                            <div class="item-title">
                                                {{ task.title }}
                                                <span class="priority-badge priority-{{ task.priority }}">
                                                    {{ ['', 'ä½', 'ä¸­', 'é«˜'][task.priority] }}ä¼˜å…ˆçº§
                                                </span>
                                                {% if task.subject %}
                                                <span class="subject-badge">{{ task.subject }}</span>
                                                {% endif %}
                                            </div>
                                            <div class="item-description">{{ task.description }}</div>
                                            <div class="item-meta">
                                                <span>å‘å¸ƒè€…: {{ task.teacher.username }}</span>
                                                <span>| åˆ›å»ºæ—¶é—´: {{ task.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                                {% if task.due_date %}
                                                <span>| æˆªæ­¢æ—¶é—´: {{ task.due_date.strftime('%Y-%m-%d %H:%M') }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="item-actions">
                                            <span class="status-tag {{ 'acknowledged' if task.is_acknowledged else 'not-acknowledged' }}">
                                                {{ 'å·²ç¡®è®¤' if task.is_acknowledged else 'æœªç¡®è®¤' }}
                                            </span>
                                            <span class="status-tag {{ 'completed' if task.is_completed else 'not-completed' }}">
                                                {{ 'å·²å®Œæˆ' if task.is_completed else 'æœªå®Œæˆ' }}
                                            </span>
                                            {% if is_class_teacher or task.teacher_id == session.user_id %}
                                            <button class="icon-btn delete-btn" onclick="deleteTask({{ task.id }})" title="åˆ é™¤ä»»åŠ¡">
                                                <i class="material-icons">delete</i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="empty-state">
                                    <p>æš‚æ— ä»»åŠ¡</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å…¬å‘Šé€‰é¡¹å¡ï¼ˆä»…ç­ä¸»ä»»å¯è§ï¼‰ -->
                {% if is_class_teacher %}
                <div id="announcements-tab" class="tab-content">
                    <div class="content-card">
                        <div class="card-content">
                            <h3>å‘å¸ƒå…¬å‘Š</h3>
                            <form id="create-announcement-form" class="announcement-form">
                                <div class="form-group">
                                    <label for="announcement-title">å…¬å‘Šæ ‡é¢˜</label>
                                    <input type="text" id="announcement-title" class="form-input" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="announcement-content">å…¬å‘Šå†…å®¹</label>
                                    <textarea id="announcement-content" class="form-textarea" rows="5" required></textarea>
                                </div>
                                
                                <div class="form-group checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="announcement-long-term" class="checkbox-input">
                                        <span class="checkbox-custom"></span>
                                        é•¿æœŸå…¬å‘Š
                                    </label>
                                </div>
                                
                                <button type="submit" class="primary-btn" id="create-announcement-btn">
                                    <span>å‘å¸ƒå…¬å‘Š</span>
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="content-card">
                        <div class="card-content">
                            <h3>å…¬å‘Šåˆ—è¡¨</h3>
                            <div class="filter-controls">
                                <button class="filter-btn active" data-filter="all">
                                    <span>å…¨éƒ¨</span>
                                </button>
                                <button class="filter-btn" data-filter="long-term">
                                    <span>é•¿æœŸå…¬å‘Š</span>
                                </button>
                                <button class="filter-btn" data-filter="regular">
                                    <span>æ™®é€šå…¬å‘Š</span>
                                </button>
                            </div>
                            <div id="announcements-list" class="items-list">
                                {% for announcement in announcements %}
                                <div class="list-item announcement-item" data-type="{% if announcement.is_long_term %}long-term{% else %}regular{% endif %}" data-id="{{ announcement.id }}">
                                    <div class="item-content">
                                        <div class="item-main">
                                            <div class="item-title">
                                                {{ announcement.title }}
                                                {% if announcement.is_long_term %}
                                                <span class="type-badge">é•¿æœŸ</span>
                                                {% endif %}
                                            </div>
                                            <div class="item-description">{{ announcement.content }}</div>
                                            <div class="item-meta">
                                                <span>å‘å¸ƒè€…: {{ announcement.teacher.username }}</span>
                                                <span>| å‘å¸ƒæ—¶é—´: {{ announcement.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                            </div>
                                        </div>
                                        <div class="item-actions">
                                            <button class="icon-btn delete-btn" onclick="deleteAnnouncement({{ announcement.id }})" title="åˆ é™¤å…¬å‘Š">
                                                <i class="material-icons">delete</i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="empty-state">
                                    <p>æš‚æ— å…¬å‘Š</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- ä½œä¸šé€‰é¡¹å¡ -->
                <div id="assignments-tab" class="tab-content">
                    <div class="content-card">
                        <div class="card-content">
                            <h3>å‘å¸ƒä½œä¸š</h3>
                            <form id="create-assignment-form" class="assignment-form">
                                <input type="hidden" id="assignment-id">
                                
                                <div class="form-group">
                                    <label for="assignment-subject">ç§‘ç›®</label>
                                    <select id="assignment-subject" class="form-select" required>
                                        <option value="">é€‰æ‹©ç§‘ç›®</option>
                                        {% if is_class_teacher %}
                                            <!-- ç­ä¸»ä»»å¯ä»¥çœ‹åˆ°æ‰€æœ‰å­¦ç§‘ -->
                                            {% for subject in class_subjects_list %}
                                                <option value="{{ subject }}">{{ subject }}</option>
                                            {% endfor %}
                                        {% elif is_teaching_teacher %}
                                            <!-- æˆè¯¾è€å¸ˆåªèƒ½çœ‹åˆ°è¢«åˆ†é…çš„å­¦ç§‘ -->
                                            {% for subject in assigned_subjects %}
                                                <option value="{{ subject }}">{{ subject }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                    <div class="form-hint">
                                        {% if is_class_teacher %}
                                        æ‚¨å¯ä»¥é€‰æ‹©æ‰€æœ‰ç­çº§å­¦ç§‘
                                        {% elif is_teaching_teacher %}
                                        æ‚¨åªèƒ½å‘å¸ƒè¢«åˆ†é…å­¦ç§‘çš„ä½œä¸š
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="form-group assignment-field" data-field="title">
                                    <label for="assignment-title">ä½œä¸šæ ‡é¢˜</label>
                                    <input type="text" id="assignment-title" class="form-input" required disabled>
                                </div>
                                
                                <div class="form-group assignment-field" data-field="description">
                                    <label for="assignment-description">ä½œä¸šæè¿°</label>
                                    <textarea id="assignment-description" class="form-textarea" rows="3" required disabled></textarea>
                                </div>
                                
                                <div class="form-group assignment-field" data-field="start-date">
                                    <label for="assignment-start-date">å‘å¸ƒæ—¥æœŸ</label>
                                    <input type="datetime-local" id="assignment-start-date" class="form-input" required disabled>
                                </div>

                                <div class="form-group assignment-field" data-field="due-date">
                                    <label for="assignment-due-date">æˆªæ­¢æ—¶é—´</label>
                                    <input type="datetime-local" id="assignment-due-date" class="form-input" required disabled>
                                </div>
                                
                                <button type="submit" class="primary-btn" id="assignment-submit-btn" disabled>
                                    <span>å‘å¸ƒä½œä¸š</span>
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="content-card">
                        <div class="card-content">
                            <h3>ä½œä¸šåˆ—è¡¨</h3>
                            <div class="filter-controls">
                                <button class="filter-btn active" data-filter="all">
                                    <span>å…¨éƒ¨</span>
                                </button>
                                <button class="filter-btn" data-filter="active">
                                    <span>è¿›è¡Œä¸­</span>
                                </button>
                                <button class="filter-btn" data-filter="upcoming">
                                    <span>å³å°†å¼€å§‹</span>
                                </button>
                                <button class="filter-btn" data-filter="completed">
                                    <span>å·²ç»“æŸ</span>
                                </button>
                            </div>
                            <div id="assignments-list" class="items-list">
                                {% for assignment in assignments %}
                                <div class="list-item assignment-item" data-status="{% if assignment.due_date < now %}completed{% else %}active{% endif %}" data-id="{{ assignment.id }}">
                                    <div class="item-content">
                                        <div class="item-main">
                                            <div class="item-title">
                                                {{ assignment.title }}
                                                <span class="subject-badge">{{ assignment.subject }}</span>
                                            </div>
                                            <div class="item-description">{{ assignment.description }}</div>
                                            <div class="item-meta">
                                                <span>å‘å¸ƒè€…: {{ assignment.teacher.username }}</span>
                                                <span>| æˆªæ­¢æ—¶é—´: {{ assignment.due_date.strftime('%Y-%m-%d %H:%M') }}</span>
                                            </div>
                                        </div>
                                        <div class="item-actions">
                                            <span class="status-tag {% if assignment.due_date < now %}completed{% else %}active{% endif %}">
                                                {% if assignment.due_date < now %}å·²ç»“æŸ{% else %}è¿›è¡Œä¸­{% endif %}
                                            </span>
                                            {% if is_class_teacher or assignment.teacher_id == session.user_id %}
                                            <button class="icon-btn delete-btn" onclick="deleteAssignment({{ assignment.id }})" title="åˆ é™¤ä½œä¸š">
                                                <i class="material-icons">delete</i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="empty-state">
                                    <p>æš‚æ— ä½œä¸š</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å†å²è®°å½•é€‰é¡¹å¡ -->
                <div id="history-tab" class="tab-content">
                    <div class="content-card">
                        <div class="card-content">
                            <h3>å†å²è®°å½•</h3>
                            <div class="filter-controls">
                                <div class="form-group">
                                    <label for="history-date">é€‰æ‹©æ—¥æœŸ</label>
                                    <input type="date" id="history-date" class="form-input" value="{{ now.strftime('%Y-%m-%d') }}">
                                </div>
                                <button class="primary-btn" onclick="loadHistory()">
                                    <span>æŸ¥è¯¢</span>
                                </button>
                            </div>
                            <div id="history-list" class="items-list">
                                <div class="empty-state">
                                    <p>è¯·é€‰æ‹©æ—¥æœŸæŸ¥è¯¢å†å²è®°å½•</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<script>
// åˆå§‹åŒ–Socket.IOè¿æ¥
const socket = io({
    transports: ['websocket', 'polling']
});

// è¿æ¥å»ºç«‹æ—¶
socket.on('connect', () => {
    console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
    socket.emit('join_teacher_room');
});

// è¿æ¥æ–­å¼€æ—¶
socket.on('disconnect', () => {
    console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
    updateWhiteboardStatus(false, 'è¿æ¥æ–­å¼€');
});

// æ¥æ”¶ç™½æ¿çŠ¶æ€æ›´æ–°
socket.on('whiteboard_status_update', (data) => {
    if (data.whiteboard_id === {{ whiteboard.id }}) {
        console.log('æ”¶åˆ°å½“å‰ç™½æ¿çŠ¶æ€æ›´æ–°:', data);
        updateWhiteboardStatus(data.is_online, data.last_heartbeat);
    }
});

// æ›´æ–°ç™½æ¿çŠ¶æ€æ˜¾ç¤º
function updateWhiteboardStatus(isOnline, lastHeartbeat) {
    const statusElement = document.getElementById('whiteboard-status');
    const heartbeatElement = document.getElementById('last-heartbeat');
    
    if (isOnline) {
        statusElement.innerHTML = '<span class="status-online">åœ¨çº¿</span>';
    } else {
        statusElement.innerHTML = '<span class="status-offline">ç¦»çº¿</span>';
    }
    
    if (lastHeartbeat) {
        heartbeatElement.textContent = `(æœ€åå¿ƒè·³: ${lastHeartbeat})`;
    }
    
    // æ·»åŠ è§†è§‰åé¦ˆ
    const infoCard = document.querySelector('.info-card');
    if (infoCard) {
        infoCard.style.transition = 'all 0.3s ease';
        if (isOnline) {
            infoCard.style.boxShadow = '0 4px 12px rgba(39, 174, 96, 0.3)';
        } else {
            infoCard.style.boxShadow = '0 4px 12px rgba(231, 76, 60, 0.3)';
        }
        
        // ç§»é™¤è§†è§‰åé¦ˆ
        setTimeout(() => {
            infoCard.style.boxShadow = '';
        }, 2000);
    }
}

// å¤åˆ¶ç™½æ¿è¿æ¥URL
function copyWhiteboardUrl() {
    navigator.clipboard.writeText("{{ whiteboard_url }}")
        .then(() => {
            showMessage('ç™½æ¿è¿æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        })
        .catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            showMessage('å¤åˆ¶å¤±è´¥: ' + err.message, 'error');
        });
}

// åˆ·æ–°ç™½æ¿çŠ¶æ€
function refreshWhiteboardStatus() {
    fetch('/whiteboards/{{ whiteboard.id }}/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateWhiteboardStatus(data.is_online, data.last_heartbeat);
                showMessage('çŠ¶æ€å·²åˆ·æ–°', 'success');
            } else {
                showMessage('è·å–çŠ¶æ€å¤±è´¥: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('åˆ·æ–°çŠ¶æ€å¤±è´¥', 'error');
        });
}

// æ˜¾ç¤ºæ¶ˆæ¯æç¤º
function showMessage(message, type = 'success') {
    // ç§»é™¤ç°æœ‰æ¶ˆæ¯
    const existingMessages = document.querySelectorAll('.message');
    existingMessages.forEach(msg => msg.remove());
    
    const messageEl = document.createElement('div');
    messageEl.className = `message ${type}`;
    messageEl.textContent = message;
    document.body.appendChild(messageEl);
    
    setTimeout(() => {
        if (document.body.contains(messageEl)) {
            messageEl.remove();
        }
    }, 3000);
}

// é€‰é¡¹å¡åˆ‡æ¢
document.querySelectorAll('.tab-btn').forEach(tab => {
    tab.addEventListener('click', () => {
        const tabName = tab.getAttribute('data-tab');
        
        // æ›´æ–°é€‰é¡¹å¡çŠ¶æ€
        document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // æ›´æ–°å†…å®¹æ˜¾ç¤º
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
    });
});

// è¿‡æ»¤å™¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const filter = btn.getAttribute('data-filter');
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // è¿‡æ»¤å†…å®¹
        const container = btn.closest('.card-content').querySelector('.items-list');
        const items = container.querySelectorAll('.list-item');
        
        items.forEach(item => {
            if (filter === 'all') {
                item.style.display = 'flex';
            } else {
                const itemType = item.getAttribute('data-status') || item.getAttribute('data-type');
                item.style.display = itemType === filter ? 'flex' : 'none';
            }
        });
    });
});

// å¯ç”¨æˆ–ç¦ç”¨ä½œä¸šè¡¨å•å­—æ®µ
function toggleAssignmentFields(enabled) {
    const fields = document.querySelectorAll('.assignment-field');
    const submitBtn = document.getElementById('assignment-submit-btn');
    
    fields.forEach(field => {
        const input = field.querySelector('input, textarea');
        if (input) {
            input.disabled = !enabled;
            field.classList.toggle('disabled', !enabled);
        }
    });
    
    submitBtn.disabled = !enabled;
}

// æ£€æŸ¥ç°æœ‰ä½œä¸š
async function checkExistingAssignment(subject) {
    if (!subject) {
        resetAssignmentForm();
        toggleAssignmentFields(false);
        return;
    }
    
    // å¯ç”¨è¡¨å•å­—æ®µ
    toggleAssignmentFields(true);
    
    try {
        const response = await fetch(`/whiteboards/{{ whiteboard.id }}/check_assignment?subject=${encodeURIComponent(subject)}`);
        const result = await response.json();
        
        if (result.assignment) {
            document.getElementById('assignment-id').value = result.assignment.id;
            document.getElementById('assignment-title').value = result.assignment.title;
            document.getElementById('assignment-description').value = result.assignment.description;
            
            // æ­£ç¡®å¤„ç†æ—¥æœŸæ—¶é—´ï¼Œä¸å†ä½¿ç”¨toISOString()
            if (result.assignment.due_date) {
                const dueDate = new Date(result.assignment.due_date);
                // è·å–æœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²ï¼Œæ ¼å¼ä¸º YYYY-MM-DDTHH:MM
                const year = dueDate.getFullYear();
                const month = String(dueDate.getMonth() + 1).padStart(2, '0');
                const day = String(dueDate.getDate()).padStart(2, '0');
                const hours = String(dueDate.getHours()).padStart(2, '0');
                const minutes = String(dueDate.getMinutes()).padStart(2, '0');
                
                document.getElementById('assignment-due-date').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
            
            document.getElementById('assignment-submit-btn').querySelector('span').textContent = 'æ›´æ–°ä½œä¸š';
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            showMessage(`å‘ç°ä»Šå¤©å·²å‘å¸ƒçš„${subject}ä½œä¸šï¼Œå¯ä»¥æ›´æ–°`, 'info');
        } else {
            resetAssignmentForm();
            document.getElementById('assignment-submit-btn').querySelector('span').textContent = 'å‘å¸ƒä½œä¸š';
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage('æ£€æŸ¥ä½œä¸šå¤±è´¥', 'error');
        resetAssignmentForm();
    }
}

// é‡ç½®ä½œä¸šè¡¨å•
function resetAssignmentForm() {
    document.getElementById('assignment-id').value = '';
    document.getElementById('assignment-title').value = '';
    document.getElementById('assignment-description').value = '';
    
    const now = new Date();
    document.getElementById('assignment-start-date').value = now.toISOString().slice(0, 16);

    // è®¾ç½®é»˜è®¤æˆªæ­¢æ—¶é—´ä¸ºæ˜å¤©åŒä¸€æ—¶é—´
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('assignment-due-date').value = tomorrow.toISOString().slice(0, 16);
    
    document.getElementById('assignment-submit-btn').querySelector('span').textContent = 'å‘å¸ƒä½œä¸š';
}

// è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
function setButtonLoading(button, isLoading) {
    const span = button.querySelector('span');
    if (isLoading) {
        button.disabled = true;
        span.textContent = 'å¤„ç†ä¸­...';
        button.classList.add('loading');
    } else {
        button.disabled = false;
        // æ ¹æ®æŒ‰é’®ç±»å‹æ¢å¤æ–‡æœ¬
        if (button.id === 'assignment-submit-btn') {
            const subject = document.getElementById('assignment-subject').value;
            span.textContent = document.getElementById('assignment-id').value ? 'æ›´æ–°ä½œä¸š' : 'å‘å¸ƒä½œä¸š';
        } else if (button.id === 'create-task-btn') {
            span.textContent = 'åˆ›å»ºä»»åŠ¡';
        } else if (button.id === 'create-announcement-btn') {
            span.textContent = 'å‘å¸ƒå…¬å‘Š';
        } else if (button.id === 'save-subjects-btn') {
            span.textContent = 'ä¿å­˜ç§‘ç›®';
        }
        button.classList.remove('loading');
    }
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´æ˜¾ç¤º
function formatDateTimeDisplay(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// åŠ è½½ä»»åŠ¡åˆ—è¡¨
async function loadTasksList() {
    try {
        const response = await fetch('/whiteboards/{{ whiteboard.id }}/tasks');
        const result = await response.json();
        
        if (result.success) {
            const tasksList = document.getElementById('tasks-list');
            tasksList.innerHTML = '';
            
            if (result.tasks.length === 0) {
                tasksList.innerHTML = '<div class="empty-state"><p>æš‚æ— ä»»åŠ¡</p></div>';
                return;
            }
            
            result.tasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'list-item task-item';
                taskItem.setAttribute('data-status', task.is_completed ? 'completed' : (task.is_acknowledged ? 'acknowledged' : 'pending'));
                taskItem.setAttribute('data-id', task.id);
                
                const priorityText = ['', 'ä½', 'ä¸­', 'é«˜'][task.priority] || 'æœªçŸ¥';
                const acknowledgedText = task.is_acknowledged ? 'å·²ç¡®è®¤' : 'æœªç¡®è®¤';
                const completedText = task.is_completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ';
                const acknowledgedClass = task.is_acknowledged ? 'acknowledged' : 'not-acknowledged';
                const completedClass = task.is_completed ? 'completed' : 'not-completed';
                const deleteButton = task.can_delete ? 
                    `<button class="icon-btn delete-btn" onclick="deleteTask(${task.id})" title="åˆ é™¤ä»»åŠ¡">
                        <i class="material-icons">delete</i>
                    </button>` : '';

                taskItem.innerHTML = `
                    <div class="item-content">
                        <div class="item-main">
                            <div class="item-title">
                                ${task.title}
                                <span class="priority-badge priority-${task.priority}">
                                    ${priorityText}ä¼˜å…ˆçº§
                                </span>
                                ${task.subject ? `<span class="subject-badge">${task.subject}</span>` : ''}
                            </div>
                            <div class="item-description">${task.description || ''}</div>
                            <div class="item-meta">
                                <span>å‘å¸ƒè€…: ${task.teacher_name}</span>
                                <span>| åˆ›å»ºæ—¶é—´: ${formatDateTimeDisplay(task.created_at)}</span>
                                ${task.due_date ? `<span>| æˆªæ­¢æ—¶é—´: ${formatDateTimeDisplay(task.due_date)}</span>` : ''}
                            </div>
                        </div>
                        <div class="item-actions">
                            <span class="status-tag ${acknowledgedClass}">
                                ${acknowledgedText}
                            </span>
                            <span class="status-tag ${completedClass}">
                                ${completedText}
                            </span>
                            ${deleteButton}
                        </div>
                    </div>
                `;
                tasksList.appendChild(taskItem);
            });
            
            // é‡æ–°åº”ç”¨è¿‡æ»¤å™¨
            const activeFilter = document.querySelector('#tasks-tab .filter-btn.active');
            if (activeFilter) {
                const filter = activeFilter.getAttribute('data-filter');
                applyTaskFilter(filter);
            }
        } else {
            throw new Error(result.error || 'åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥', 'error');
    }
}

// åº”ç”¨ä»»åŠ¡è¿‡æ»¤å™¨
function applyTaskFilter(filter) {
    const tasksList = document.getElementById('tasks-list');
    const items = tasksList.querySelectorAll('.task-item');
    
    items.forEach(item => {
        if (filter === 'all') {
            item.style.display = 'flex';
        } else {
            const itemStatus = item.getAttribute('data-status');
            item.style.display = itemStatus === filter ? 'flex' : 'none';
        }
    });
}

// åŠ è½½å…¬å‘Šåˆ—è¡¨
async function loadAnnouncementsList() {
    try {
        const response = await fetch('/whiteboards/{{ whiteboard.id }}/announcements');
        const result = await response.json();
        
        if (result.success) {
            const announcementsList = document.getElementById('announcements-list');
            announcementsList.innerHTML = '';
            
            if (result.announcements.length === 0) {
                announcementsList.innerHTML = '<div class="empty-state"><p>æš‚æ— å…¬å‘Š</p></div>';
                return;
            }
            
            result.announcements.forEach(announcement => {
                const announcementItem = document.createElement('div');
                announcementItem.className = 'list-item announcement-item';
                announcementItem.setAttribute('data-type', announcement.is_long_term ? 'long-term' : 'regular');
                announcementItem.setAttribute('data-id', announcement.id);
                
                announcementItem.innerHTML = `
                    <div class="item-content">
                        <div class="item-main">
                            <div class="item-title">
                                ${announcement.title}
                                ${announcement.is_long_term ? '<span class="type-badge">é•¿æœŸ</span>' : ''}
                            </div>
                            <div class="item-description">${announcement.content}</div>
                            <div class="item-meta">
                                <span>å‘å¸ƒè€…: ${announcement.teacher_name}</span>
                                <span>| å‘å¸ƒæ—¶é—´: ${formatDateTimeDisplay(announcement.created_at)}</span>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="icon-btn delete-btn" onclick="deleteAnnouncement(${announcement.id})" title="åˆ é™¤å…¬å‘Š">
                                <i class="material-icons">delete</i>
                            </button>
                        </div>
                    </div>
                `;
                announcementsList.appendChild(announcementItem);
            });
            
            // é‡æ–°åº”ç”¨è¿‡æ»¤å™¨
            const activeFilter = document.querySelector('#announcements-tab .filter-btn.active');
            if (activeFilter) {
                const filter = activeFilter.getAttribute('data-filter');
                applyAnnouncementFilter(filter);
            }
        } else {
            throw new Error(result.error || 'åŠ è½½å…¬å‘Šåˆ—è¡¨å¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage('åŠ è½½å…¬å‘Šåˆ—è¡¨å¤±è´¥', 'error');
    }
}

// åº”ç”¨å…¬å‘Šè¿‡æ»¤å™¨
function applyAnnouncementFilter(filter) {
    const announcementsList = document.getElementById('announcements-list');
    const items = announcementsList.querySelectorAll('.announcement-item');
    
    items.forEach(item => {
        if (filter === 'all') {
            item.style.display = 'flex';
        } else {
            const itemType = item.getAttribute('data-type');
            item.style.display = itemType === filter ? 'flex' : 'none';
        }
    });
}

// åŠ è½½ä½œä¸šåˆ—è¡¨
async function loadAssignmentsList() {
    try {
        const response = await fetch('/whiteboards/{{ whiteboard.id }}/assignments');
        const result = await response.json();
        
        if (result.success) {
            const assignmentsList = document.getElementById('assignments-list');
            assignmentsList.innerHTML = '';
            
            if (result.assignments.length === 0) {
                assignmentsList.innerHTML = '<div class="empty-state"><p>æš‚æ— ä½œä¸š</p></div>';
                return;
            }
            
            result.assignments.forEach(assignment => {
                const assignmentItem = document.createElement('div');
                assignmentItem.className = 'list-item assignment-item';
                
                const dueDate = new Date(assignment.due_date);
                const now = new Date();
                const status = dueDate < now ? 'completed' : 'active';
                const statusText = status === 'completed' ? 'å·²ç»“æŸ' : 'è¿›è¡Œä¸­';
                
                assignmentItem.setAttribute('data-status', status);
                assignmentItem.setAttribute('data-id', assignment.id);
                const deleteButton = assignment.can_delete ? 
                    `<button class="icon-btn delete-btn" onclick="deleteAssignment(${assignment.id})" title="åˆ é™¤ä½œä¸š">
                        <i class="material-icons">delete</i>
                    </button>` : '';

                assignmentItem.innerHTML = `
                    <div class="item-content">
                        <div class="item-main">
                            <div class="item-title">
                                ${assignment.title}
                                <span class="subject-badge">${assignment.subject}</span>
                            </div>
                            <div class="item-description">${assignment.description}</div>
                            <div class="item-meta">
                                <span>å‘å¸ƒè€…: ${assignment.teacher_name}</span>
                                <span>| æˆªæ­¢æ—¶é—´: ${formatDateTimeDisplay(assignment.due_date)}</span>
                            </div>
                        </div>
                        <div class="item-actions">
                            <span class="status-tag ${status}">
                                ${statusText}
                            </span>
                            ${deleteButton}
                        </div>
                    </div>
                `;
                assignmentsList.appendChild(assignmentItem);
            });
            
            // é‡æ–°åº”ç”¨è¿‡æ»¤å™¨
            const activeFilter = document.querySelector('#assignments-tab .filter-btn.active');
            if (activeFilter) {
                const filter = activeFilter.getAttribute('data-filter');
                applyAssignmentFilter(filter);
            }
        } else {
            throw new Error(result.error || 'åŠ è½½ä½œä¸šåˆ—è¡¨å¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage('åŠ è½½ä½œä¸šåˆ—è¡¨å¤±è´¥', 'error');
    }
}

// åº”ç”¨ä½œä¸šè¿‡æ»¤å™¨
function applyAssignmentFilter(filter) {
    const assignmentsList = document.getElementById('assignments-list');
    const items = assignmentsList.querySelectorAll('.assignment-item');
    
    items.forEach(item => {
        if (filter === 'all') {
            item.style.display = 'flex';
        } else {
            const itemStatus = item.getAttribute('data-status');
            item.style.display = itemStatus === filter ? 'flex' : 'none';
        }
    });
}

// è¡¨å•æäº¤å¤„ç†
document.getElementById('create-task-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const createTaskBtn = document.getElementById('create-task-btn');
    setButtonLoading(createTaskBtn, true);
    
    const dueDate = document.getElementById('task-due-date').value;
    const subject = document.getElementById('task-subject').value;
    const formData = {
        title: document.getElementById('task-title').value,
        description: document.getElementById('task-description').value,
        priority: parseInt(document.getElementById('task-priority').value),
        action_id: parseInt(document.getElementById('task-action').value),
        subject: subject,
        due_date: dueDate ? dueDate : null  // ç›´æ¥ä¼ é€’åŸå§‹å­—ç¬¦ä¸²
    };
    
    try {
        const response = await fetch('/whiteboards/{{ whiteboard.id }}/create_task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('create-task-form').reset();
            showMessage('ä»»åŠ¡åˆ›å»ºæˆåŠŸ', 'success');
            // é‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
            await loadTasksList();
        } else {
            throw new Error(result.error || 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage(error.message, 'error');
    } finally {
        setButtonLoading(createTaskBtn, false);
    }
});

{% if is_class_teacher %}
document.getElementById('create-announcement-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const createAnnouncementBtn = document.getElementById('create-announcement-btn');
    setButtonLoading(createAnnouncementBtn, true);
    
    const formData = {
        title: document.getElementById('announcement-title').value,
        content: document.getElementById('announcement-content').value,
        is_long_term: document.getElementById('announcement-long-term').checked
    };
    
    try {
        const response = await fetch('/whiteboards/{{ whiteboard.id }}/create_announcement', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('create-announcement-form').reset();
            showMessage('å…¬å‘Šå‘å¸ƒæˆåŠŸ', 'success');
            // é‡æ–°åŠ è½½å…¬å‘Šåˆ—è¡¨
            await loadAnnouncementsList();
        } else {
            throw new Error(result.error || 'å‘å¸ƒå…¬å‘Šå¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage(error.message, 'error');
    } finally {
        setButtonLoading(createAnnouncementBtn, false);
    }
});
{% endif %}

document.getElementById('create-assignment-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const assignmentSubmitBtn = document.getElementById('assignment-submit-btn');
    setButtonLoading(assignmentSubmitBtn, true);
    
    const formData = {
        id: document.getElementById('assignment-id').value,
        title: document.getElementById('assignment-title').value,
        description: document.getElementById('assignment-description').value,
        subject: document.getElementById('assignment-subject').value,
        start_date: document.getElementById('assignment-start-date').value,  // ç›´æ¥ä¼ é€’åŸå§‹å­—ç¬¦ä¸²
        due_date: document.getElementById('assignment-due-date').value     // ç›´æ¥ä¼ é€’åŸå§‹å­—ç¬¦ä¸²
    };
    
    try {
        const response = await fetch('/whiteboards/{{ whiteboard.id }}/create_assignment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            resetAssignmentForm();
            document.getElementById('assignment-subject').value = '';
            toggleAssignmentFields(false);
            showMessage(result.is_update ? 'ä½œä¸šæ›´æ–°æˆåŠŸ' : 'ä½œä¸šå‘å¸ƒæˆåŠŸ', 'success');
            // é‡æ–°åŠ è½½ä½œä¸šåˆ—è¡¨
            await loadAssignmentsList();
        } else {
            throw new Error(result.error || 'æ“ä½œå¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage(error.message, 'error');
    } finally {
        setButtonLoading(assignmentSubmitBtn, false);
    }
});

// ç§‘ç›®ä¿å­˜è¡¨å•å¤„ç†
/*
document.querySelector('.settings-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const saveSubjectsBtn = document.getElementById('save-subjects-btn');
    setButtonLoading(saveSubjectsBtn, true);
    
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('{{ url_for('whiteboards.view_whiteboard', whiteboard_id=whiteboard.id) }}', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            showMessage('ç§‘ç›®ä¿å­˜æˆåŠŸ', 'success');
            // é‡æ–°åŠ è½½ç§‘ç›®é€‰æ‹©æ¡†
            const subjects = formData.get('subjects');
            if (subjects) {
                const subjectSelect = document.getElementById('assignment-subject');
                subjectSelect.innerHTML = '<option value="">é€‰æ‹©ç§‘ç›®</option>';
                subjects.split(',').forEach(sub => {
                    const trimmedSub = sub.trim();
                    if (trimmedSub) {
                        const option = document.createElement('option');
                        option.value = trimmedSub;
                        option.textContent = trimmedSub;
                        subjectSelect.appendChild(option);
                    }
                });
                
                // åŒæ—¶æ›´æ–°ä»»åŠ¡ç§‘ç›®çš„é€‰æ‹©æ¡†
                const taskSubjectSelect = document.getElementById('task-subject');
                taskSubjectSelect.innerHTML = '<option value="">æ— å…³è”å­¦ç§‘</option>';
                subjects.split(',').forEach(sub => {
                    const trimmedSub = sub.trim();
                    if (trimmedSub) {
                        const option = document.createElement('option');
                        option.value = trimmedSub;
                        option.textContent = trimmedSub;
                        taskSubjectSelect.appendChild(option);
                    }
                });
            }
        } else {
            throw new Error('ä¿å­˜ç§‘ç›®å¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage(error.message, 'error');
    } finally {
        setButtonLoading(saveSubjectsBtn, false);
    }
});
*/

// åˆ é™¤åŠŸèƒ½
async function deleteTask(taskId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(`/tasks/${taskId}/delete`, { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showMessage('ä»»åŠ¡å·²åˆ é™¤', 'success');
            // é‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
            await loadTasksList();
        } else {
            throw new Error(result.error || 'åˆ é™¤ä»»åŠ¡å¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage(error.message, 'error');
    }
}

async function deleteAnnouncement(announcementId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…¬å‘Šå—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(`/announcements/${announcementId}/delete`, { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showMessage('å…¬å‘Šå·²åˆ é™¤', 'success');
            // é‡æ–°åŠ è½½å…¬å‘Šåˆ—è¡¨
            await loadAnnouncementsList();
        } else {
            throw new Error(result.error || 'åˆ é™¤å…¬å‘Šå¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage(error.message, 'error');
    }
}

async function deleteAssignment(assignmentId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä½œä¸šå—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(`/assignments/${assignmentId}/delete`, { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showMessage('ä½œä¸šå·²åˆ é™¤', 'success');
            // é‡æ–°åŠ è½½ä½œä¸šåˆ—è¡¨
            await loadAssignmentsList();
        } else {
            throw new Error(result.error || 'åˆ é™¤ä½œä¸šå¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage(error.message, 'error');
    }
}

// åŠ è½½å†å²è®°å½•
async function loadHistory() {
    const date = document.getElementById('history-date').value;
    
    if (!date) {
        showMessage('è¯·é€‰æ‹©æ—¥æœŸ', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/whiteboards/{{ whiteboard.id }}/history?date=${date}`);
        const result = await response.json();
        
        if (result.success) {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if (result.data.length === 0) {
                historyList.innerHTML = '<div class="empty-state"><p>è¯¥æ—¥æœŸæ— å†å²è®°å½•</p></div>';
                return;
            }
            
            result.data.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'list-item history-item';
                historyItem.innerHTML = `
                    <div class="item-content">
                        <div class="item-main">
                            <div class="item-title">${item.type}: ${item.title}</div>
                            <div class="item-description">${item.description || ''}</div>
                            <div class="item-meta">
                                <span>æ—¶é—´: ${item.created_at}</span>
                            </div>
                        </div>
                    </div>
                `;
                historyList.appendChild(historyItem);
            });
        } else {
            throw new Error(result.error || 'åŠ è½½å†å²è®°å½•å¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage(error.message, 'error');
    }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    // è®¾ç½®é»˜è®¤æ—¥æœŸæ—¶é—´
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('assignment-start-date').value = now.toISOString().slice(0, 16);
    document.getElementById('assignment-due-date').value = tomorrow.toISOString().slice(0, 16);
    
    const dayAfterTomorrow = new Date(now);
    dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
    document.getElementById('task-due-date').value = dayAfterTomorrow.toISOString().slice(0, 16);
    
    // åˆå§‹åŒ–ä½œä¸šè¡¨å•çŠ¶æ€
    toggleAssignmentFields(false);
    
    // ä¸ºç§‘ç›®é€‰æ‹©æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
    const subjectSelect = document.getElementById('assignment-subject');
    if (subjectSelect) {
        subjectSelect.addEventListener('change', function() {
            checkExistingAssignment(this.value);
        });
    }
    
    // ä¸ºè¿‡æ»¤å™¨æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('#tasks-tab .filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const filter = e.target.getAttribute('data-filter');
            applyTaskFilter(filter);
        });
    });
    
    document.querySelectorAll('#announcements-tab .filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const filter = e.target.getAttribute('data-filter');
            applyAnnouncementFilter(filter);
        });
    });
    
    document.querySelectorAll('#assignments-tab .filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const filter = e.target.getAttribute('data-filter');
            applyAssignmentFilter(filter);
        });
    });
});
</script>

<style>
.primary-btn.loading {
    background: #bdc3c7;
    cursor: not-allowed;
}

.primary-btn.loading::after {
    content: '';
    display: inline-block;
    width: 16px;
    height: 16px;
    margin-left: 8px;
    border: 2px solid transparent;
    border-top: 2px solid #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.view-whiteboard-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

/* æ ‡é¢˜åŒºåŸŸ */
.whiteboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding: 0 8px;
}

.whiteboard-title {
    font-size: 2rem;
    font-weight: 700;
    color: #2c3e50;
    margin: 0;
}

.whiteboard-actions {
    display: flex;
    gap: 12px;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    text-decoration: none;
}

.action-btn:hover {
    background: #2980b9;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* å¡ç‰‡æ ·å¼ */
.info-card, .settings-card, .content-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    margin-bottom: 24px;
    overflow: hidden;
}

.card-content {
    padding: 24px;
}

/* ä¿¡æ¯ç½‘æ ¼ */
.info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
}

.info-section h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 16px;
}

.info-item {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    gap: 8px;
}

.info-label {
    font-weight: 500;
    color: #7f8c8d;
    min-width: 80px;
}

.info-value {
    color: #2c3e50;
}

.url-text {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    color: #3498db;
}

/* çŠ¶æ€æŒ‡ç¤ºå™¨ */
.status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-online {
    color: #27ae60;
    font-weight: 600;
}

.status-offline {
    color: #e74c3c;
    font-weight: 600;
}

.heartbeat-time {
    font-size: 12px;
    color: #95a5a6;
}

/* äºŒç»´ç å®¹å™¨ */
.qrcode-container {
    margin-top: 16px;
    display: flex;
    justify-content: center;
}

/* è®¾ç½®è¡¨å• */
.settings-form {
    max-width: 500px;
}

/* é€‰é¡¹å¡å¯¼èˆª */
.tab-navigation {
    margin: 32px 0 24px;
}

.tab-scroller {
    overflow-x: auto;
    border-bottom: 2px solid #ecf0f1;
}

.tab-list {
    display: flex;
    gap: 0;
    min-width: max-content;
}

.tab-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    color: #7f8c8d;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.tab-btn:hover {
    color: #3498db;
    background: #f8f9fa;
}

.tab-btn.active {
    color: #3498db;
    border-bottom-color: #3498db;
    background: #f8f9fa;
}

.tab-icon {
    font-size: 16px;
}

.tab-label {
    font-weight: 500;
}

/* é€‰é¡¹å¡å†…å®¹ */
.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* è¡¨å•æ ·å¼ */
.form-group {
    margin-bottom: 20px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: #2c3e50;
}

.form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #ecf0f1;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.form-input:disabled, .form-textarea:disabled {
    background-color: #f8f9fa;
    color: #95a5a6;
    cursor: not-allowed;
}

.form-textarea {
    resize: vertical;
    min-height: 80px;
}

.form-hint {
    font-size: 12px;
    color: #7f8c8d;
    margin-top: 4px;
}

/* å¤é€‰æ¡† */
.checkbox-group {
    display: flex;
    align-items: center;
}

.checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    gap: 8px;
}

.checkbox-input {
    display: none;
}

.checkbox-custom {
    width: 18px;
    height: 18px;
    border: 2px solid #bdc3c7;
    border-radius: 4px;
    position: relative;
    transition: all 0.3s ease;
}

.checkbox-input:checked + .checkbox-custom {
    background: #3498db;
    border-color: #3498db;
}

.checkbox-input:checked + .checkbox-custom::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
}

/* æŒ‰é’®æ ·å¼ */
.primary-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.primary-btn:hover:not(:disabled) {
    background: #2980b9;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.primary-btn:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* è¿‡æ»¤å™¨æ§åˆ¶ */
.filter-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
}

.filter-btn {
    padding: 8px 16px;
    border: 2px solid #ecf0f1;
    background: white;
    border-radius: 20px;
    cursor: pointer;
    font-size: 13px;
    color: #7f8c8d;
    transition: all 0.3s ease;
}

.filter-btn:hover {
    border-color: #3498db;
    color: #3498db;
}

.filter-btn.active {
    background: #3498db;
    border-color: #3498db;
    color: white;
}

/* åˆ—è¡¨æ ·å¼ */
.items-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.list-item {
    background: white;
    border: 1px solid #ecf0f1;
    border-radius: 8px;
    padding: 16px;
    transition: all 0.3s ease;
}

.list-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}

.item-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
}

.item-main {
    flex: 1;
}

.item-title {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.item-description {
    color: #7f8c8d;
    margin-bottom: 8px;
    line-height: 1.5;
}

.item-meta {
    font-size: 12px;
    color: #95a5a6;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.item-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}

/* å¾½ç« æ ·å¼ */
.priority-badge, .type-badge, .subject-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.priority-1 { background: #d4efdf; color: #27ae60; }
.priority-2 { background: #fdebd0; color: #f39c12; }
.priority-3 { background: #fadbd8; color: #e74c3c; }

.type-badge { background: #e8f6f3; color: #16a085; }
.subject-badge { background: #e8f4fd; color: #2980b9; }

/* çŠ¶æ€æ ‡ç­¾ */
.status-tag {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 500;
}

.status-tag.acknowledged { background: #d4efdf; color: #27ae60; }
.status-tag.not-acknowledged { background: #fadbd8; color: #e74c3c; }
.status-tag.completed { background: #d4efdf; color: #27ae60; }
.status-tag.not-completed { background: #fdebd0; color: #f39c12; }
.status-tag.active { background: #d6eaf8; color: #3498db; }

/* å›¾æ ‡æŒ‰é’® */
.icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px;
    border-radius: 6px;
    color: #7f8c8d;
    transition: all 0.3s ease;
}

.icon-btn:hover {
    background: #f8f9fa;
    color: #e74c3c;
}

.delete-btn:hover {
    background: #fadbd8;
}

/* ç©ºçŠ¶æ€ */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #95a5a6;
}

.empty-state p {
    margin: 0;
    font-size: 14px;
}

/* æ¶ˆæ¯æç¤º */
.message {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    animation: slideIn 0.3s ease;
}

.message.success { background: #27ae60; }
.message.error { background: #e74c3c; }

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* ç¦ç”¨å­—æ®µæ ·å¼ */
.assignment-field.disabled {
    opacity: 0.6;
}

.assignment-field.disabled label {
    color: #95a5a6;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .view-whiteboard-container {
        padding: 12px;
    }
    
    .whiteboard-header {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
    }
    
    .whiteboard-actions {
        width: 100%;
        justify-content: flex-start;
    }
    
    .info-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .item-content {
        flex-direction: column;
        gap: 12px;
    }
    
    .item-actions {
        align-self: flex-end;
    }
    
    .tab-list {
        gap: 0;
    }
    
    .tab-btn {
        padding: 10px 16px;
    }
}
</style>
{% endblock %}